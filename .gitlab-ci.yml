# 変数定義
variables:
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHA

# ステージ定義
stages:
  - lint
  - test
  - build
  - deploy

# Lint ステージ：コードチェック
lint:
  stage: lint
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache git
  script:
    - gofmt -l . | tee /tmp/gofmt.txt
    - test ! -s /tmp/gofmt.txt
    - go vet ./...
  only:
    - merge_requests
    - main

# Test ステージ：単体テスト + カバレッジ
test:
  stage: test
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache git
  script:
    - go test -v -coverprofile=coverage.out ./...
    - go tool cover -func=coverage.out
  coverage: '/total:.*?(\d+\.\d+)%/'
  artifacts:
    paths:
      - coverage.out
    expire_in: 1 week
  only:
    - merge_requests
    - main

# Build ステージ：Kaniko でイメージビルド & プッシュ
build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.23.2-debug
    entrypoint: [""]
  before_script:
    # GitLab Registry 認証情報を設定（Registry + GitLab本体の両方）
    - mkdir -p /kaniko/.docker
    - |
      AUTH=$(printf "%s:%s" "${CI_REGISTRY_USER}" "${CI_REGISTRY_PASSWORD}" | base64 | tr -d '\n')
      cat > /kaniko/.docker/config.json << EOF
      {
        "auths": {
          "${CI_REGISTRY}": {"auth": "${AUTH}"},
          "192.168.3.101": {"auth": "${AUTH}"}
        }
      }
      EOF
    # 証明書を配置
    - |
      if [ -f /tmp/gitlab-certs/ca.crt ]; then
        echo "Installing CA certificates for Kaniko..."
        mkdir -p /kaniko/ssl/certs
        cat /tmp/gitlab-certs/ca.crt >> /kaniko/ssl/certs/ca-certificates.crt
      fi
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}"
      --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
      --destination "${IMAGE_NAME}:${IMAGE_TAG}"
      --destination "${IMAGE_NAME}:latest"
      --build-arg "VERSION=${CI_COMMIT_TAG}"
      --build-arg "GIT_COMMIT=${CI_COMMIT_SHA}"
      --skip-tls-verify
  only:
    - merge_requests
    - main

# Deploy ステージ：Kubernetes へデプロイ
deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_CONTENT" | base64 -d > ~/.kube/config
    - chmod 600 ~/.kube/config
    - kubectl version --client
    - kubectl cluster-info
  script:
    - kubectl apply -f k8s/namespace.yaml
    
    # Deploy Token を使用（CI_JOB_TOKEN ではなく永続トークン）
    - |
      kubectl create secret docker-registry gitlab-registry-secret \
        --docker-server=$CI_REGISTRY \
        --docker-username=$DEPLOY_TOKEN_USERNAME \
        --docker-password=$DEPLOY_TOKEN_PASSWORD \
        --namespace=hello-gin \
        --dry-run=client -o yaml | kubectl apply -f -
    
    - kubectl apply -f k8s/configmap.yaml
    
    - |
      sed -i "s|image: .*|image: $IMAGE_NAME:$IMAGE_TAG|g" k8s/deployment.yaml
    
    - kubectl apply -f k8s/deployment.yaml
    - kubectl apply -f k8s/service.yaml
    - kubectl apply -f k8s/ingress.yaml
    
    - kubectl rollout status deployment/hello-gin -n hello-gin --timeout=5m
    
    - echo "Deployment completed successfully!"
    - kubectl get pods -n hello-gin
    - kubectl get svc -n hello-gin
    - kubectl get ingress -n hello-gin
  environment:
    name: production
    url: http://hello-gin.local
  only:
    - main
