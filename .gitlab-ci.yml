# Docker イメージとサービスの設定
image: docker:24-git

services:
  - docker:24-dind

# 変数定義
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_SHA

# ステージ定義
stages:
  - lint
  - test
  - build
  - scan
  - push
  - deploy

# ビルド前の共通処理
before_script:
  - docker info

# Lint ステージ：コードチェック
lint:
  stage: lint
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache git
  script:
    # go fmt チェック（フォーマット）
    - gofmt -l . | tee /tmp/gofmt.txt
    - test ! -s /tmp/gofmt.txt
    # go vet チェック（静的解析）
    - go vet ./...
  only:
    - merge_requests
    - main

# 単体テストステージ：単体テスト＋カバレッジ
test:
  stage: test
  image: golang:1.24-alpine
  before_script:
    - apk add --no-cache git
  script:
    # テスト実行
    - go test -v -race -coverprofile=coverage.out ./...
    # カバレッジ表示
    - go tool cover -func=coverage.out
    # カバレッジ閾値チェック（80%未満で失敗）
    - |
      COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
      echo "Coverage: ${COVERAGE}%"
      if (( $(echo "$COVERAGE < 80" | bc -l) )); then
        echo "Coverage is below 80%"
        exit 1
      fi
  coverage: '/total:.*?(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.out
    paths:
      - coverage.out
    expire_in: 1 week
  only:
    - merge_requests
    - main

# Build ステージ：Docker イメージビルド
build:
  stage: build
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    # Docker イメージビルド
    - docker build 
        --build-arg VERSION=$CI_COMMIT_TAG
        --build-arg GIT_COMMIT=$CI_COMMIT_SHA
        -t $IMAGE_NAME:$IMAGE_TAG
        -t $IMAGE_NAME:latest
        .
    # ビルド成功確認
    - docker images $IMAGE_NAME
  after_script:
    - docker logout $CI_REGISTRY
  only:
    - merge_requests
    - main

# 脆弱性スキャンステージ：Trivyを使用した脆弱性スキャン
scan:
  stage: scan
  image: aquasec/trivy:latest
  variables:
    # Trivy のキャッシュディレクトリ
    TRIVY_CACHE_DIR: ".trivycache/"
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    # Docker イメージをスキャン
    - trivy image 
        --severity HIGH,CRITICAL
        --exit-code 0
        --no-progress
        --format table
        $IMAGE_NAME:$IMAGE_TAG
    # JSON レポート生成（Artifacts 用）
    - trivy image
        --severity HIGH,CRITICAL
        --exit-code 0
        --no-progress
        --format json
        --output trivy-report.json
        $IMAGE_NAME:$IMAGE_TAG
  cache:
    paths:
      - .trivycache/
  artifacts:
    reports:
      container_scanning: trivy-report.json
    paths:
      - trivy-report.json
    expire_in: 1 week
  allow_failure: true
  only:
    - merge_requests
    - main

# Push ステージ：Container Registry へ push
push:
  stage: push
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    # commit SHA タグを push
    - docker push $IMAGE_NAME:$IMAGE_TAG
    # latest タグを push
    - docker push $IMAGE_NAME:latest
    # push 成功確認
    - echo "Image pushed successfully:"
    - echo "  $IMAGE_NAME:$IMAGE_TAG"
    - echo "  $IMAGE_NAME:latest"
  after_script:
    - docker logout $CI_REGISTRY
  only:
    - main

# Deploy ステージ：Kubernetes へデプロイ
deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  before_script:
    # kubectl の設定
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_CONTENT" | base64 -d > ~/.kube/config
    - chmod 600 ~/.kube/config
    # 接続確認
    - kubectl version --client
    - kubectl cluster-info
  script:
    # Namespace 作成（存在しない場合）
    - kubectl apply -f k8s/namespace.yaml
    
    # imagePullSecret 作成・更新
    - |
      kubectl create secret docker-registry gitlab-registry-secret \
        --docker-server=$CI_REGISTRY \
        --docker-username=$CI_REGISTRY_USER \
        --docker-password=$CI_REGISTRY_PASSWORD \
        --namespace=hello-gin \
        --dry-run=client -o yaml | kubectl apply -f -
    
    # ConfigMap 適用
    - kubectl apply -f k8s/configmap.yaml
    
    # Deployment の image タグを commit SHA に置き換え
    - |
      sed -i "s|image: .*|image: $IMAGE_NAME:$IMAGE_TAG|g" k8s/deployment.yaml
    
    # Deployment, Service, Ingress 適用
    - kubectl apply -f k8s/deployment.yaml
    - kubectl apply -f k8s/service.yaml
    - kubectl apply -f k8s/ingress.yaml
    
    # デプロイ状態確認
    - kubectl rollout status deployment/hello-gin -n hello-gin --timeout=5m
    
    # デプロイ結果表示
    - echo "Deployment completed successfully!"
    - kubectl get pods -n hello-gin
    - kubectl get svc -n hello-gin
    - kubectl get ingress -n hello-gin
  environment:
    name: production
    url: http://hello-gin.local
  only:
    - main